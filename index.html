<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Prayaan Cabs - Premium car rental services in Tamil Nadu, Kerala, Karnataka, Andhra Pradesh."/>
  <title>Prayaan Cabs | Premium Car Hire & Taxi Services</title>
  <link rel="shortcut icon" href="images/favicon.png">
  <link rel="stylesheet" href="style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Compact Vehicle Grid */
    .vehicle-tariff-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 12px;
      text-align: center;
    }
    .vehicle-tariff-card {
      background: transparent;
      border: 1px solid #eee;
      box-shadow: none;
      padding: 10px;
      cursor: pointer;
      transition: transform 0.15s ease, border-color 0.15s ease;
      border-radius: 8px;
    }
    .vehicle-tariff-card:hover { transform: translateY(-4px); border-color:#d1e7ff; }
    .vehicle-tariff-card.selected {
      background: rgba(0, 123, 255, 0.06);
      border-color: #007bff;
    }
    .vehicle-icon-circle-horizontal img { width: 40px; height: 30px; object-fit: contain; margin-bottom:6px; }
    .vehicle-name-horizontal { font-size: 14px; font-weight: 600; color: #222; line-height:1.1; }
    .vehicle-category { font-size: 12px; color: #666; margin-bottom: 4px; }
    .tariff-price { font-size: 14px; font-weight: 700; color: #007bff; }

    @media (max-width: 576px) {
      .vehicle-tariff-grid { grid-template-columns: repeat(3, 1fr); gap: 6px; }
      .vehicle-icon-circle-horizontal img { width: 30px; height: 24px; }
      .vehicle-name-horizontal { font-size: 12px; }
      .tariff-price { font-size: 12px; }
    }

    .btn-back { background: transparent; border: 1px solid #ddd; padding: .375rem .75rem; border-radius: .375rem; }
    .summary-box { background: #f8f9fa; }
    .small-muted { color: #6c757d; font-size: 0.95rem; }
    pre#fareBreakdownText { margin:0; font-family: inherit; white-space: pre-wrap; }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top shadow-sm">
    <div class="container">
      <a class="navbar-brand" href="#home">
        <img src="images/logo.png" alt="Prayaan Logo" class="brand-logo" onerror="this.style.display='none'">
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
    <li class="nav-item"><a class="nav-link active" href="index.html">Home</a></li>
    <li class="nav-item"><a class="nav-link" href="services.html">Services</a></li>
    <li class="nav-item"><a class="nav-link" href="destinations.html">Destinations</a></li>
    <li class="nav-item"><a class="nav-link" href="about.html">About Us</a></li>
    <li class="nav-item"><a class="nav-link" href="vendor.html">Vendor Registration</a></li>
    <li class="nav-item"><a class="nav-link btn btn-primary text-white px-3 ms-2" href="#booking">Book Now</a></li>
  </ul>

      </div>
    </div>
  </nav>

  <!-- Quick Booking Section -->
  <section id="booking" class="booking-section py-5">
    <div class="container">
      <div class="section-header text-center mb-4">
        <h2>Book Your Ride</h2>
        <p class="small-muted">Enter your trip details to see instant pricing</p>
      </div>
      <div class="row justify-content-center">
        <div class="col-lg-11">
          <div class="booking-form-card p-3 shadow-sm rounded">

            <!-- Trip Type Selector -->
            <div class="trip-type-selector-horizontal d-flex justify-content-center gap-3 mb-3">
              <div class="trip-type-btn-horizontal active p-2" data-trip="oneway" style="cursor:pointer;">
                <i class="fas fa-route me-1"></i><span>One Way</span>
              </div>
              <div class="trip-type-btn-horizontal p-2" data-trip="roundtrip" style="cursor:pointer;">
                <i class="fas fa-exchange-alt me-1"></i><span>Round Trip</span>
              </div>
              <div class="trip-type-btn-horizontal p-2" data-trip="local" style="cursor:pointer;">
                <i class="fas fa-map-marked-alt me-1"></i><span>Local</span>
              </div>
            </div>

            <form id="bookingForm" onsubmit="return false;">
              <!-- One Way Form -->
              <div id="onewayForm" class="form-section active">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-map-marker-alt"></i> From</label>
                    <input type="text" class="form-control location-input" id="onewayPickup" placeholder="Enter starting location" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-flag-checkered"></i> To</label>
                    <input type="text" class="form-control location-input" id="onewayDrop" placeholder="Enter destination" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-calendar-alt"></i> Date & Time</label>
                    <input type="datetime-local" class="form-control" id="onewayDateTime" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-users"></i> Passengers</label>
                    <input type="number" class="form-control" id="onewayPassengers" placeholder="Number of people" min="1" max="50" required>
                  </div>
                </div>
              </div>

              <!-- Round Trip Form -->
              <div id="roundtripForm" class="form-section" style="display:none;">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-map-marker-alt"></i> From</label>
                    <input type="text" class="form-control location-input" id="roundtripPickup" placeholder="Enter starting location" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-flag-checkered"></i> To</label>
                    <input type="text" class="form-control location-input" id="roundtripDrop" placeholder="Enter destination" required>
                  </div>
                  <div class="col-12" id="intermediateStops"></div>
                  <div class="col-12">
                    <button type="button" class="add-stop-btn btn btn-outline-primary btn-sm" id="addStopBtn">
                      <i class="fas fa-plus-circle"></i> Add Stop
                    </button>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-calendar-alt"></i> Pickup Date & Time</label>
                    <input type="datetime-local" class="form-control" id="roundtripPickupDateTime" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-calendar-check"></i> Return Date & Time</label>
                    <input type="datetime-local" class="form-control" id="roundtripReturnDateTime" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-users"></i> Passengers</label>
                    <input type="number" class="form-control" id="roundtripPassengers" min="1" max="50" required>
                  </div>
                </div>
              </div>

              <!-- Local Trip Form -->
              <div id="localForm" class="form-section" style="display:none;">
                <div class="local-package-selector mb-3 d-flex flex-wrap gap-2">
                  <div class="package-option p-2 border rounded" data-package="4hrs">
                    <div class="package-header fw-semibold">4 Hours</div>
                    <div class="package-detail small-muted">Free 40 KM</div>
                  </div>
                  <div class="package-option active p-2 border rounded" data-package="8hrs">
                    <div class="package-header fw-semibold">8 Hours</div>
                    <div class="package-detail small-muted">Free 80 KM</div>
                  </div>
                  <div class="package-option p-2 border rounded" data-package="10hrs">
                    <div class="package-header fw-semibold">10 Hours</div>
                    <div class="package-detail small-muted">Free 100 KM</div>
                  </div>
                  <div class="package-option p-2 border rounded" data-package="12hrs">
                    <div class="package-header fw-semibold">12 Hours</div>
                    <div class="package-detail small-muted">Free 120 KM</div>
                  </div>
                </div>

                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-map-marker-alt"></i> Pickup</label>
                    <input type="text" class="form-control location-input" id="localPickup" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-calendar-alt"></i> Date & Time</label>
                    <input type="datetime-local" class="form-control" id="localDateTime" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-users"></i> Passengers</label>
                    <input type="number" class="form-control" id="localPassengers" min="1" max="50" required>
                  </div>
                </div>
              </div>

              <!-- Loading Spinner -->
              <div class="loading-spinner text-center my-3" id="loadingSpinner" style="display:none;">
                <i class="fas fa-spinner fa-spin fa-3x text-primary"></i>
                <p class="small-muted">Calculating prices...</p>
              </div>

              <!-- Vehicle Selection -->
              <div id="vehicleTariffSection" class="vehicle-tariff-section" style="display:none;">
    <h5 class="text-center mb-3">Choose Your Vehicle</h5>

    <div id="vehicleTariffGrid" class="vehicle-tariff-grid"></div>

    <!-- Traveller info (shown only for local trips) -->
    <div id="travellerNote" class="text-center small-muted mt-3" style="display:none;">
      <i class="fas fa-info-circle text-primary"></i>
      For <b>Tempo Traveller</b> bookings, kindly call us at
      <a href="tel:+919500530043" class="text-decoration-none fw-semibold">95005 30043</a>.
    </div>

    <div class="extra-charges-note mt-3 text-center small-muted">
      <i class="fas fa-info-circle"></i> Note: Tolls, parking & permits are extra
    </div>
  </div>


              <!-- Customer Info Page -->
              <div id="customerInfoPage" style="display:none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <button id="backToVehiclesBtn" class="btn-back"><i class="fas fa-arrow-left"></i> Back</button>
                  <h5 class="mb-0">Your Details</h5>
                  <div style="width:64px"></div>
                </div>

                <p class="text-center small-muted mb-4">Please provide your name and contact number to continue.</p>
                <div class="row g-3">
                  <div class="col-md-6 mx-auto">
                    <label class="form-label"><i class="fas fa-user"></i> Full Name</label>
                    <input type="text" class="form-control" id="customerName" placeholder="Enter your full name" required>
                  </div>
                  <div class="col-md-6 mx-auto">
                    <label class="form-label"><i class="fas fa-phone"></i> Phone Number</label>
                    <input type="tel" class="form-control" id="customerPhone" placeholder="10-digit mobile number" pattern="[0-9]{10}" required>
                  </div>
                </div>
                <div class="text-center mt-4">
                  <button type="button" id="customerNextBtn" class="btn btn-success btn-lg w-100">Continue to Booking Summary</button>
                </div>
              </div>

              <!-- Booking Preview -->
              <div id="bookingPreviewSection" style="display:none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <button id="backToCustomerBtn" class="btn-back"><i class="fas fa-arrow-left"></i> Back</button>
                  <h5 class="mb-0">Booking Summary</h5>
                  <div style="width:64px"></div>
                </div>

                <div class="summary-box border rounded p-3 mb-3">
                  <p id="summaryTripDetails" class="mb-2"></p>
                  <p id="summaryVehicle" class="fw-bold mb-1"></p>
                  <p id="summaryBasePrice" class="text-primary fw-semibold mb-0"></p>
                </div>

                <!-- Fare Breakdown -->
    <div id="fareBreakdownBox" class="border rounded p-3 mb-3">
      <h6 class="mb-2">Note</h6>
      <pre id="fareBreakdownText" class="mb-0 small-muted"></pre>
    </div>

    <!-- Terms & Conditions -->
    <div class="border rounded p-3 mb-3 bg-light small-muted">
      <h6 class="mb-2"><i class="fas fa-info-circle text-primary"></i> Terms & Conditions</h6>
      <ul class="mb-0 ps-3">
        <li>KM & time counted from office to office</li>
        <li>Note starting KM reading before trip</li>
        <li>A/C off in hills or while idle</li>
        <li>‚Çπ400 night allowance (9 PM ‚Äì 6 AM)</li>
        <li>Ensure your stay has nearby parking facilities</li>
        <li>Vomit cleaning charges apply if vehicle is soiled</li>
      </ul>
    </div>


                <!-- Add-ons -->
                <h6 class="mb-2">Add Extra Services (Optional)</h6>
                <div class="addon-options border rounded p-3 mb-3">
                  <div class="form-check">
                    <input class="form-check-input addon-checkbox" type="checkbox" id="addonLuggage" data-price="149">
                    <label class="form-check-label" for="addonLuggage">Cab with Luggage Carrier (+ ‚Çπ149)</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input addon-checkbox" type="checkbox" id="addonLanguage" data-price="199">
                    <label class="form-check-label" for="addonLanguage">Driver Who Knows Your Language (+ ‚Çπ199)</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input addon-checkbox" type="checkbox" id="addonNewCar" data-price="249">
                    <label class="form-check-label" for="addonNewCar">New Car Promise (2022-2025 Model) (+ ‚Çπ249)</label>
                  </div>
                </div>

                <div class="fare-preview text-center mb-2">
                  <h5>Total Fare: <span id="totalFare" class="text-success fw-bold">‚Çπ0</span></h5>
                </div>

                <div class="text-center small-muted mb-3">Tolls, Parking & Permits are extra</div>

                <button type="button" id="finalProceedBtn" class="btn btn-success btn-lg w-100">
                  <i class="fab fa-whatsapp"></i> Proceed to WhatsApp
                </button>
              </div>

            </form>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Hero + Services + Features (kept short, optional visuals) -->
  <section id="home" class="hero-section py-5">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-6 mb-4 mb-lg-0">
          <h1 class="hero-title">Premium Car Rental Services</h1>
          <p class="hero-subtitle small-muted">Comfortable, reliable, and affordable car hire across South India.</p>
          <a href="#booking" class="btn btn-primary btn-lg mt-3">Book Now <i class="fas fa-arrow-right ms-2"></i></a>
        </div>
        <div class="col-lg-6">
          <img src="images/flota.jpg" alt="Premium Car Rental" class="img-fluid rounded" onerror="this.src='https://images.unsplash.com/photo-1449965408869-eaa3f722e40d?w=800'">
        </div>
      </div>
    </div>
  </section>

  <!-- scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Google Places (keep your API key here) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBC6yIwGEbnc5IM_Fpa8M-CrZsnUt83BPQ&libraries=places"></script>

  <script>
  /* ====== Data & State ====== */
  const vehiclePricing = {
    oneway: {
      'Swift Dzire / Toyota Etios': { perKm: 20, icon: 'fa-car', image: 'images/sedan.png', category: 'Sedan' },
      'Mahindra Xylo / Ertiga': { perKm: 24, icon: 'fa-car-side', image: 'images/ertiga.png', category: 'SUV' },
      'Innova': { perKm: 28, icon: 'fa-shuttle-van', image: 'images/innova.png', category: 'MPV' },
      'Innova Crysta': { perKm: 30, icon: 'fa-van-shuttle', image: 'images/crysta.png', category: 'Premium MPV' },
      'Traveller': { perKm: 40, icon: 'fa-bus', image: 'images/tempo.png', category: '12/14-seater TT' }
    },
    roundtrip: {
      'Swift Dzire / Toyota Etios': { dayRent: 2000, perKm: 12, icon: 'fa-car', image: 'images/sedan.png', category: 'Sedan' },
      'Mahindra Xylo / Ertiga': { dayRent: 2200, perKm: 12, icon: 'fa-car-side', image: 'images/xuv.png', category: 'SUV' },
      'Innova': { dayRent: 2500, perKm: 14, icon: 'fa-shuttle-van', image: 'images/innova.png', category: 'MPV' },
      'Innova Crysta': { dayRent: 3000, perKm: 15, icon: 'fa-van-shuttle', image: 'images/crysta.png', category: 'Premium MPV' },
      'Traveller': { dayRent: 3500, perKm: 18, icon: 'fa-bus', image: 'images/tempo.png', category: '12/14-seater TT' }
    },
    local: {
      '4hrs': {
        'Swift Dzire': { packageRate: 1450, freeKm: 40, extraPerKm: 13, extraHour: 250, icon: 'fa-car', image: 'images/sedan.png', category: 'Sedan' },
        'Toyota Etios': { packageRate: 1450, freeKm: 40, extraPerKm: 13, extraHour: 250, icon: 'fa-car', image: 'images/ertiga.png', category: 'Sedan' },
        'Innova': { packageRate: 2200, freeKm: 40, extraPerKm: 15, extraHour: 300, icon: 'fa-shuttle-van', image: 'images/innova.png', category: 'MPV' },
        'Innova Crysta': { packageRate: 2500, freeKm: 40, extraPerKm: 18, extraHour: 400, icon: 'fa-van-shuttle', image: 'images/crysta.png', category: 'Premium MPV' },
        'Traveller': { packageRate: 3000, freeKm: 40, extraPerKm: 19, extraHour: 450, icon: 'fa-bus', image: 'images/tempo.png', category: '12/14-seater TT' }
      },
      '8hrs': {
        'Swift Dzire': { packageRate: 2450, freeKm: 80, extraPerKm: 13, extraHour: 250, icon: 'fa-car', image: 'images/sedan.png', category: 'Sedan' },
        'Toyota Etios': { packageRate: 2450, freeKm: 80, extraPerKm: 13, extraHour: 250, icon: 'fa-car', image: 'images/ertiga.png', category: 'Sedan' },
        'Innova': { packageRate: 3500, freeKm: 80, extraPerKm: 15, extraHour: 300, icon: 'fa-shuttle-van', image: 'images/innova.png', category: 'MPV' },
        'Innova Crysta': { packageRate: 4500, freeKm: 80, extraPerKm: 18, extraHour: 500, icon: 'fa-van-shuttle', image: 'images/crysta.png', category: 'Premium MPV' },
        'Traveller': { packageRate: 4800, freeKm: 80, extraPerKm: 19, extraHour: 500, icon: 'fa-bus', image: 'images/tempo.png', category: '12/14-seater TT' }
      },
      '10hrs': {
        'Swift Dzire': { packageRate: 2850, freeKm: 100, extraPerKm: 13, extraHour: 250, icon: 'fa-car', image: 'images/sedan.png', category: 'Sedan' },
        'Toyota Etios': { packageRate: 2850, freeKm: 100, extraPerKm: 13, extraHour: 250, icon: 'fa-car', image: 'images/ertiga.png', category: 'Sedan' },
        'Innova': { packageRate: 4000, freeKm: 100, extraPerKm: 15, extraHour: 300, icon: 'fa-shuttle-van', image: 'images/innova.png', category: 'MPV' },
        'Innova Crysta': { packageRate: 5000, freeKm: 100, extraPerKm: 18, extraHour: 500, icon: 'fa-van-shuttle', image: 'images/crysta.png', category: 'Premium MPV' },
        'Traveller': { packageRate: 5300, freeKm: 100, extraPerKm: 19, extraHour: 500, icon: 'fa-bus', image: 'images/tempo.png', category: '12/14-seater TT' }
      },
      '12hrs': {
        'Swift Dzire': { packageRate: 3400, freeKm: 120, extraPerKm: 13, extraHour: 250, icon: 'fa-car', image: 'images/sedan.png', category: 'Sedan' },
        'Toyota Etios': { packageRate: 3400, freeKm: 120, extraPerKm: 13, extraHour: 250, icon: 'fa-car', image: 'images/ertiga.png', category: 'Sedan' },
        'Innova': { packageRate: 4800, freeKm: 120, extraPerKm: 15, extraHour: 300, icon: 'fa-shuttle-van', image: 'images/innova.png', category: 'MPV' },
        'Innova Crysta': { packageRate: 5800, freeKm: 120, extraPerKm: 18, extraHour: 500, icon: 'fa-van-shuttle', image: 'images/crysta.png', category: 'Premium MPV' },
        'Traveller': { packageRate: 6000, freeKm: 120, extraPerKm: 19, extraHour: 500, icon: 'fa-bus', image: 'images/tempo.png', category: '12/14-seater TT' }
      }
    }
  };

  let currentTripType = 'oneway';
  let selectedLocalPackage = '8hrs';
  let intermediateStopCount = 0;
  let autocompleteInstances = [];
  let selectedVehicle = null;
  let lastComputedDistance = 0;
  let lastComputedDays = 1;
  let lastBasePrice = 0;

  /* ====== Autocomplete init ====== */
  function initAutocomplete(){
    document.querySelectorAll('.location-input').forEach(input => {
      if (!input.dataset.autoinit) {
        try {
          const ac = new google.maps.places.Autocomplete(input, { componentRestrictions: { country: 'in' } });
          autocompleteInstances.push(ac);
        } catch (e) {
          // fail silently if API not available
        }
        input.dataset.autoinit = '1';
      }
    });
  }

  /* ====== Update form sections (enable/disable) ====== */
  function updateFormSections(){
    document.querySelectorAll('.form-section').forEach(section=>{
      const isActive = section.classList.contains('active') || section.style.display !== 'none';
      section.querySelectorAll('input, select, textarea, button').forEach(el=>{
        if (el === document.getElementById('addStopBtn')) return;
        el.disabled = !isActive;
      });
    });
  }

  /* ====== Trip type switcher ====== */
  document.getElementById('vehicleTariffSection').style.display = 'none';

  document.querySelectorAll('.trip-type-btn-horizontal').forEach(btn=>{
    btn.addEventListener('click', function(){
      document.querySelectorAll('.trip-type-btn-horizontal').forEach(b=>b.classList.remove('active'));
      this.classList.add('active');
      currentTripType = this.dataset.trip;
      // show/hide forms
      document.getElementById('onewayForm').style.display = currentTripType==='oneway' ? 'block' : 'none';
      document.getElementById('roundtripForm').style.display = currentTripType==='roundtrip' ? 'block' : 'none';
      document.getElementById('localForm').style.display = currentTripType==='local' ? 'block' : 'none';
      // hide downstream pages
      document.getElementById('vehicleTariffSection').style.display = 'none';
      document.getElementById('customerInfoPage').style.display = 'none';
      document.getElementById('bookingPreviewSection').style.display = 'none';
      updateFormSections();
      initAutocomplete();
    });
  });

  /* ====== Add / remove stops ====== */
  document.getElementById('addStopBtn').addEventListener('click', ()=>{
    intermediateStopCount++;
    const stopDiv = document.createElement('div');
    stopDiv.className = 'intermediate-stop mb-2';
    stopDiv.innerHTML = `
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">Stop ${intermediateStopCount}</h6>
        <button type="button" class="remove-stop-btn btn btn-sm btn-outline-danger"><i class="fas fa-times"></i></button>
      </div>
      <input type="text" class="form-control location-input" placeholder="Enter location">
    `;
    document.getElementById('intermediateStops').appendChild(stopDiv);
    const removeBtn = stopDiv.querySelector('.remove-stop-btn');
    removeBtn.addEventListener('click', ()=>{ stopDiv.remove(); updateFormSections(); });
    const newInput = stopDiv.querySelector('.location-input');
    try { new google.maps.places.Autocomplete(newInput, { componentRestrictions: { country: 'in' } }); } catch(e){}
  });

  /* ====== Distance calc helper (Google DistanceMatrix) ====== */
  async function calculateDistance(origins, destinations) {
    return new Promise((resolve, reject)=>{
      try {
        const service = new google.maps.DistanceMatrixService();
        service.getDistanceMatrix({
          origins, destinations, travelMode: google.maps.TravelMode.DRIVING, unitSystem: google.maps.UnitSystem.METRIC
        }, (response, status) => {
          if (status === 'OK') resolve(response);
          else reject(status);
        });
      } catch(e) {
        reject(e);
      }
    });
  }

  /* ====== MAIN PRICING FLOW (updated with correct round trip logic) ====== */
async function calculateAndDisplayAllPrices(){
  const spinner = document.getElementById('loadingSpinner');
  spinner.style.display = 'block';
  document.getElementById('vehicleTariffSection').style.display = 'none';
  document.getElementById('customerInfoPage').style.display = 'none';
  document.getElementById('bookingPreviewSection').style.display = 'none';

  try {
    let totalDistance = 0;
    let days = 1;

    function isCoimbatoreLocation(text){
      if (!text) return false;
      return text.toLowerCase().includes('coimbatore');
    }

    if (currentTripType === 'oneway') {
      const from = document.getElementById('onewayPickup').value.trim();
      const to = document.getElementById('onewayDrop').value.trim();
      const pax = parseInt(document.getElementById('onewayPassengers').value || 0);
      if (!from || !to || pax <= 0) { spinner.style.display='none'; return; }


      // forward distance
      const res1 = await calculateDistance([from],[to]);
      let forwardDistance = (res1.rows[0].elements[0].distance.value || 0) / 1000;

      // add return distance only if pickup is Coimbatore
      let returnDistance = 0;
      if (isCoimbatoreLocation(from)) {
        const coimbatore = "Coimbatore, Tamil Nadu";
        try {
          const res2 = await calculateDistance([to],[coimbatore]);
          returnDistance = (res2.rows[0].elements[0].distance.value || 0) / 1000;
        } catch(e){}
      }

      totalDistance = forwardDistance + returnDistance;
      lastComputedDistance = Math.round(totalDistance);
      lastComputedDays = 1;
      displayAllVehiclePrices(totalDistance, 1);
    }

    else if (currentTripType === 'roundtrip') {
      const from = document.getElementById('roundtripPickup').value.trim();
      const to = document.getElementById('roundtripDrop').value.trim();
      const pickupRaw = document.getElementById('roundtripPickupDateTime').value;
      const returnRaw = document.getElementById('roundtripReturnDateTime').value;
      if (!from || !to || !pickupRaw || !returnRaw) { spinner.style.display='none'; return; }

      // compute inclusive calendar days
      const pDateFull = new Date(pickupRaw);
      const rDateFull = new Date(returnRaw);
      const msPerDay = 1000 * 60 * 60 * 24;
      let rawDays = Math.floor((rDateFull - pDateFull) / msPerDay) + 1;
      if (!isFinite(rawDays) || rawDays < 1) rawDays = 1;
      days = rawDays;

      // collect route stops
      const locs = [from];
      document.querySelectorAll('#intermediateStops .location-input').forEach(i => {
        if (i.value && i.value.trim()) locs.push(i.value.trim());
      });
      locs.push(to);

      // forward distance (pickup -> stops -> drop)
      let forwardDistance = 0;
      for (let i = 0; i < locs.length - 1; i++) {
        try {
          const res = await calculateDistance([locs[i]], [locs[i+1]]);
          forwardDistance += ((res.rows[0].elements[0].distance.value || 0) / 1000);
        } catch(e){}
      }

      // return distance
      let returnDistance = 0;
      if (isCoimbatoreLocation(from)) {
        const coimbatore = "Coimbatore, Tamil Nadu";
        try {
          const resBack = await calculateDistance([to],[coimbatore]);
          returnDistance = (resBack.rows[0].elements[0].distance.value || 0) / 1000;
        } catch(e){}
      }

      totalDistance = forwardDistance + returnDistance;
      lastComputedDistance = Math.round(totalDistance);
      lastComputedDays = days;
      displayAllVehiclePrices(totalDistance, days);
    }

    else if (currentTripType === 'local') {
      displayLocalTariffs();
    }

  } catch(e){
    console.error(e);
    alert('Unable to calculate distance. Please check locations and try again.');
  } finally {
    spinner.style.display = 'none';
  }
}

  /* ====== Attach handler when clicking a vehicle card ====== */
  function attachVehicleClickHandler(card, basePrice){
    card.addEventListener('click', ()=>{
      document.querySelectorAll('.vehicle-tariff-card').forEach(c=>c.classList.remove('selected'));
      card.classList.add('selected');
      selectedVehicle = card.querySelector('.vehicle-name-horizontal').textContent.trim();
      lastBasePrice = basePrice;

      // hide forms
      document.getElementById('vehicleTariffSection').style.display = 'none';
      document.getElementById('onewayForm').style.display = 'none';
      document.getElementById('roundtripForm').style.display = 'none';
      document.getElementById('localForm').style.display = 'none';

      // show customer info
      document.getElementById('customerInfoPage').style.display = 'block';
      document.getElementById('bookingPreviewSection').style.display = 'none';
    });
  }

  /* ====== helper: strip HTML for WhatsApp ====== */
  function stripHtml(html){
    const tmp = document.createElement('DIV');
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || "";
  }

  /* ====== Show booking preview and fare breakdown ====== */
  function showBookingPreview(basePrice) {
    document.getElementById('vehicleTariffSection').style.display = 'none';
    document.getElementById('customerInfoPage').style.display = 'none';

    let summaryHTML = '';
    if (currentTripType === 'oneway') {
      const from = document.getElementById('onewayPickup').value;
      const to = document.getElementById('onewayDrop').value;
      const dt = new Date(document.getElementById('onewayDateTime').value).toLocaleString('en-IN');
      const pax = document.getElementById('onewayPassengers').value;
      summaryHTML = `<b>From:</b> ${from}<br><b>To:</b> ${to}<br><b>Date & Time:</b> ${dt}<br><b>Passengers:</b> ${pax}`;
      // breakdown
      const cfg = vehiclePricing.oneway[selectedVehicle] || {};
      const perKm = cfg.perKm || 0;
      const distance = lastComputedDistance || 0;
      const totalComputed = Math.round(perKm * distance);
      const breakdown = `Per KM: ‚Çπ${perKm}\nDistance: ${distance} km\nBase Fare: ‚Çπ${totalComputed}`;
      document.getElementById('fareBreakdownText').textContent = breakdown;
      lastBasePrice = totalComputed;
    }
    else if (currentTripType === 'roundtrip') {
      const from = document.getElementById('roundtripPickup').value;
      const to = document.getElementById('roundtripDrop').value;
      const pickup = new Date(document.getElementById('roundtripPickupDateTime').value).toLocaleString('en-IN');
      const ret = new Date(document.getElementById('roundtripReturnDateTime').value).toLocaleString('en-IN');
      const pax = document.getElementById('roundtripPassengers').value;
      let stops = [];
      document.querySelectorAll('#intermediateStops .location-input').forEach(i => { if (i.value && i.value.trim()) stops.push(i.value.trim()); });
      const stopLine = stops.length ? `<b>Intermediate Stops:</b> ${stops.join(', ')}<br>` : '';
      summaryHTML = `<b>From:</b> ${from}<br>${stopLine}<b>To:</b> ${to}<br><b>Pickup:</b> ${pickup}<br><b>Return:</b> ${ret}<br><b>Passengers:</b> ${pax}`;

      const cfg = vehiclePricing.roundtrip[selectedVehicle] || {};
      const dayRent = cfg.dayRent || 0;
      const perKm = cfg.perKm || 0;
      const days = lastComputedDays || 1;
      const distance = lastComputedDistance || 0;
      const baseTotal = Math.round((dayRent * days) + (perKm * distance));
      const breakdown = `No. of Days: ${days}\nKilometer limit: ${distance} km\nExtra Day Charge: ‚Çπ${dayRent}\nExtra km Charge: ‚Çπ${perKm} /km\nTotal (Base Fare): ‚Çπ${baseTotal}`;
      document.getElementById('fareBreakdownText').textContent = breakdown;
      lastBasePrice = baseTotal;
    }
    else {
      const pickup = document.getElementById('localPickup').value;
      const dt = new Date(document.getElementById('localDateTime').value).toLocaleString('en-IN');
      const pax = document.getElementById('localPassengers').value;
      summaryHTML = `<b>Pickup:</b> ${pickup}<br><b>Date & Time:</b> ${dt}<br><b>Passengers:</b> ${pax}<br><b>Package:</b> ${selectedLocalPackage.toUpperCase()}`;
      const pkgCfg = vehiclePricing.local[selectedLocalPackage] || {};
      let pkgInfo = 'Package Rate: -';
      if (pkgCfg[selectedVehicle]) {
        pkgInfo = `Package Rate: ‚Çπ${pkgCfg[selectedVehicle].packageRate}\nFree KM: ${pkgCfg[selectedVehicle].freeKm} km`;
        lastBasePrice = pkgCfg[selectedVehicle].packageRate;
      } else {
        lastBasePrice = 0;
      }
      document.getElementById('fareBreakdownText').textContent = pkgInfo;
    }

    document.getElementById('summaryTripDetails').innerHTML = summaryHTML;
    document.getElementById('summaryVehicle').textContent = `Vehicle: ${selectedVehicle || 'Not selected'}`;
    document.getElementById('summaryBasePrice').textContent = `Base Fare: ‚Çπ${lastBasePrice}`;
    document.getElementById('bookingPreviewSection').style.display = 'block';
    document.getElementById('totalFare').textContent = `‚Çπ${lastBasePrice}`;

    // reset add-ons
    document.querySelectorAll('.addon-checkbox').forEach(chk => { chk.checked = false; });

    // update total when add-ons change
    function updateTotalFare(){
      let total = parseInt(lastBasePrice || 0, 10);
      document.querySelectorAll('.addon-checkbox:checked').forEach(chk => {
        total += parseInt(chk.dataset.price || 0, 10);
      });
      document.getElementById('totalFare').textContent = `‚Çπ${total}`;
    }

    // rebind checkboxes defensively
    document.querySelectorAll('.addon-checkbox').forEach(chk => {
      chk.onchange = updateTotalFare;
    });
  }

  /* ====== Display available vehicles (oneway/roundtrip) ====== */
  function displayAllVehiclePrices(distance, days) {
    const data = vehiclePricing[currentTripType] || {};
    const grid = document.getElementById('vehicleTariffGrid');
    grid.innerHTML = '';
    const pax = parseInt(document.querySelector(`#${currentTripType}Passengers`) ? document.querySelector(`#${currentTripType}Passengers`).value : 0, 10) || 0;

    Object.keys(data).forEach(v => {
      if (pax > 7 && v !== 'Traveller') return;
      const p = data[v];
      let total = 0;
      if (currentTripType === 'oneway') {
        const perKm = p.perKm || 0;
        total = Math.round(distance * perKm);
      } else {
        const dayRent = p.dayRent || 0;
        const perKm = p.perKm || 0;
        total = Math.round((dayRent * days) + (distance * perKm));
      }
      const card = document.createElement('div');
      card.className = 'vehicle-tariff-card';
      card.innerHTML = `
        <div style="min-height:56px;">
          <div class="vehicle-icon-circle-horizontal"><img src="${p.image}" alt="${v}" onerror="this.style.display='none'"></div>
          <div class="vehicle-name-horizontal">${v}</div>
          <div class="vehicle-category">${p.category||''}</div>
        </div>
        <div class="tariff-price">Rs. ${total}</div>
      `;
      grid.appendChild(card);
      attachVehicleClickHandler(card, total);
    });

    document.getElementById('vehicleTariffSection').style.display = 'block';
  }

  /* ====== Display local package vehicles ====== */
  function displayLocalTariffs() {
    const data = vehiclePricing.local[selectedLocalPackage] || {};
    const grid = document.getElementById('vehicleTariffGrid');
    grid.innerHTML = '';
    const pax = parseInt(document.getElementById('localPassengers').value || 0, 10) || 0;

    // üü¢ Loop through vehicles ‚Äî exclude Traveller
    Object.keys(data).forEach(v => {
      if (v.toLowerCase().includes('traveller')) return; // ‚ùå Skip Traveller completely

      const p = data[v];
      const base = p.packageRate || 0;
      const card = document.createElement('div');
      card.className = 'vehicle-tariff-card';
      card.innerHTML = `
        <div style="min-height:56px;">
          <div class="vehicle-icon-circle-horizontal">
            <img src="${p.image}" alt="${v}" onerror="this.style.display='none'">
          </div>
          <div class="vehicle-name-horizontal">${v}</div>
          <div class="vehicle-category">${p.category || ''}</div>
        </div>
        <div class="tariff-price">Rs. ${base}</div>
      `;
      grid.appendChild(card);
      attachVehicleClickHandler(card, base);
    });

    // üü¢ Show Traveller note only in Local trip mode
    document.getElementById('travellerNote').style.display = 'block';

    document.getElementById('vehicleTariffSection').style.display = 'block';
  }


  /* ====== Input listeners to trigger calculation ====== */
  document.querySelectorAll('#onewayPassengers, #roundtripPassengers, #localPassengers').forEach(inp=>{
    inp.addEventListener('change', ()=> { if (parseInt(inp.value||0,10) > 0) calculateAndDisplayAllPrices(); });
  });

  document.querySelectorAll('.package-option').forEach(opt=>{
    opt.addEventListener('click', function(){
      document.querySelectorAll('.package-option').forEach(o=>o.classList.remove('active'));
      this.classList.add('active');
      selectedLocalPackage = this.dataset.package;
      if (currentTripType === 'local') displayLocalTariffs();
    });
  });

  /* ====== Back buttons behavior ====== */
  document.getElementById('backToVehiclesBtn').addEventListener('click', ()=>{
    document.getElementById('customerInfoPage').style.display = 'none';
    document.getElementById('vehicleTariffSection').style.display = 'block';
    document.getElementById('onewayForm').style.display = currentTripType==='oneway' ? 'block' : 'none';
    document.getElementById('roundtripForm').style.display = currentTripType==='roundtrip' ? 'block' : 'none';
    document.getElementById('localForm').style.display = currentTripType==='local' ? 'block' : 'none';
  });
  document.getElementById('backToCustomerBtn').addEventListener('click', ()=>{
    document.getElementById('bookingPreviewSection').style.display = 'none';
    document.getElementById('customerInfoPage').style.display = 'block';
  });

  /* ====== Customer continue to preview ====== */
  document.getElementById('customerNextBtn').addEventListener('click', ()=>{
    const name = document.getElementById('customerName').value.trim();
    const phone = document.getElementById('customerPhone').value.trim();
    if (!name || !phone) {
      alert('Please enter name and phone.');
      return;
    }
    // get selected card price (stored in lastBasePrice by attach click)
    showBookingPreview(lastBasePrice);
  });

  /* ====== Final WhatsApp button ====== */
  document.getElementById('finalProceedBtn').addEventListener('click', ()=>{
    const name = document.getElementById('customerName').value.trim();
    const phone = document.getElementById('customerPhone').value.trim();
    if (!name || !phone) { alert('Please enter name and phone.'); return; }

    // ‚úÖ Ensure pickup time is at least 1 hour from now
    let pickupTime = null;
    if (currentTripType === 'oneway') {
      pickupTime = new Date(document.getElementById('onewayDateTime').value);
    } else if (currentTripType === 'roundtrip') {
      pickupTime = new Date(document.getElementById('roundtripPickupDateTime').value);
    } else if (currentTripType === 'local') {
      pickupTime = new Date(document.getElementById('localDateTime').value);
    }

    if (pickupTime && !isNaN(pickupTime)) {
      const now = new Date();
      const diffMinutes = (pickupTime - now) / (1000 * 60);
      if (diffMinutes < 60) {
        alert('‚ö†Ô∏è Please book at least 1 hour before pickup time.');
        return;
      }
    }

    const totalText = document.getElementById('totalFare').textContent.replace('‚Çπ','').trim();
    const addons = [];
    document.querySelectorAll('.addon-checkbox:checked').forEach(chk=>{
      addons.push(chk.nextElementSibling.textContent.trim());
    });
    const addonText = addons.length ? `\nAdd-ons:\n- ${addons.join('\n- ')}` : '';

    const tripDetails = stripHtml(document.getElementById('summaryTripDetails').innerHTML);
    const breakdown = document.getElementById('fareBreakdownText').textContent;
    const msg = `üöó New Booking - Prayaan Cabs\n\nName: ${name}\nPhone: ${phone}\nTrip Type: ${currentTripType.toUpperCase()}\nVehicle: ${selectedVehicle}\nBase Fare: ‚Çπ${lastBasePrice}\nTotal Fare: ‚Çπ${totalText}${addonText}\n\nTrip Details:\n${tripDetails}\n\nAdditional Charges:\n${breakdown}\n\nNote: Tolls, parking & permits are extra.`;

    const waUrl = `https://wa.me/919500530043?text=${encodeURIComponent(msg)}`;
    window.open(waUrl, '_blank');
  });

  /* ====== When user changes main fields -> recalc ====== */
  window.addEventListener('load', ()=>{
    initAutocomplete();
    updateFormSections();
    // set min for datetime-local inputs
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.querySelectorAll('input[type="datetime-local"]').forEach(i => i.min = now.toISOString().slice(0,16));
    // Trigger recalculation only for the currently active form
    function triggerRecalculation() {
      if (currentTripType === 'oneway') {
        const from = document.getElementById('onewayPickup').value.trim();
        const to = document.getElementById('onewayDrop').value.trim();
        const pax = parseInt(document.getElementById('onewayPassengers').value || 0);
        if (from && to && pax > 0) calculateAndDisplayAllPrices();
      }
      else if (currentTripType === 'roundtrip') {
        const from = document.getElementById('roundtripPickup').value.trim();
        const to = document.getElementById('roundtripDrop').value.trim();
        const pickup = document.getElementById('roundtripPickupDateTime').value;
        const ret = document.getElementById('roundtripReturnDateTime').value;
        const pax = parseInt(document.getElementById('roundtripPassengers').value || 0);
        if (from && to && pickup && ret && pax > 0) calculateAndDisplayAllPrices();
      }
      else if (currentTripType === 'local') {
        const pickup = document.getElementById('localPickup').value.trim();
        const dt = document.getElementById('localDateTime').value;
        const pax = parseInt(document.getElementById('localPassengers').value || 0);
        if (pickup && dt && pax > 0) calculateAndDisplayAllPrices();
      }
    }

    ['onewayPickup','onewayDrop','onewayDateTime','onewayPassengers',
     'roundtripPickup','roundtripDrop','roundtripPickupDateTime','roundtripReturnDateTime','roundtripPassengers',
     'localPickup','localDateTime','localPassengers']
    .forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.addEventListener('change', triggerRecalculation);
    });

  });
  </script>
</body>
</html>


