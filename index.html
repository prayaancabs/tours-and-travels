<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Prayaan Cabs - Premium car rental services in Tamil Nadu, Kerala, Karnataka, Andhra Pradesh."/>
  <title>Prayaan Cabs | Premium Car Hire & Taxi Services</title>
  <link rel="shortcut icon" href="images/favicon.png">
  <link rel="stylesheet" href="style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <style>
    /* Compact Vehicle Grid */
    .vehicle-tariff-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 12px;
      text-align: center;
    }
    .vehicle-tariff-card {
      background: transparent;
      border: 1px solid #eee;
      box-shadow: none;
      padding: 10px;
      cursor: pointer;
      transition: transform 0.15s ease, border-color 0.15s ease;
      border-radius: 8px;
    }
    .vehicle-tariff-card:hover { transform: translateY(-4px); border-color:#d1e7ff; }
    .vehicle-tariff-card.selected {
      background: rgba(0, 123, 255, 0.06);
      border-color: #007bff;
    }
    .vehicle-icon-circle-horizontal img { width: 40px; height: 30px; object-fit: contain; margin-bottom:6px; }
    .vehicle-name-horizontal { font-size: 14px; font-weight: 600; color: #222; line-height:1.1; }
    .vehicle-category { font-size: 12px; color: #666; margin-bottom: 4px; }
    .tariff-price { font-size: 14px; font-weight: 700; color: #007bff; }

    @media (max-width: 576px) {
      .vehicle-tariff-grid { grid-template-columns: repeat(3, 1fr); gap: 6px; }
      .vehicle-icon-circle-horizontal img { width: 30px; height: 24px; }
      .vehicle-name-horizontal { font-size: 12px; }
      .tariff-price { font-size: 12px; }
    }

    .btn-back { background: transparent; border: 1px solid #ddd; padding: .375rem .75rem; border-radius: .375rem; }
    .summary-box { background: #f8f9fa; }
    .small-muted { color: #6c757d; font-size: 0.95rem; }
    pre#fareBreakdownText { margin:0; font-family: inherit; white-space: pre-wrap; }

    .floating-contact {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 999;
    }
    .call-btn, .whatsapp-btn {
      width: 48px;
      height: 48px;
    }
  </style>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17734250014"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'AW-17734250014');
  </script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17734014377"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag2(){dataLayer.push(arguments);}
    gtag2('js', new Date());
    gtag2('config', 'AW-17734014377');
  </script>
  <!-- Event snippet for Phone call lead conversion page -->
  <script>
    gtag('event', 'conversion', {'send_to': 'AW-17734014377/tewdCKjJosIbEKmrnohC'});
  </script>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top shadow-sm">
    <div class="container">
      <a class="navbar-brand" href="#home">
        <img src="https://prayaancabs.com/images/Logo.png" alt="Prayaan Logo" class="brand-logo" onerror="this.style.display='none'">
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link active" href="index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="services.html">Services</a></li>
          <li class="nav-item"><a class="nav-link" href="destinations.html">Destinations</a></li>
          <li class="nav-item"><a class="nav-link" href="about.html">About Us</a></li>
          <li class="nav-item"><a class="nav-link" href="vendor.html">Vendor Registration</a></li>
          <li class="nav-item"><a class="nav-link btn btn-primary text-white px-3 ms-2" href="#booking">Book Now</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Quick Booking Section -->
  <section id="booking" class="booking-section py-5">
    <div class="container">
      <div class="section-header text-center mb-4">
        <h2>Book Your Ride</h2>
        <p class="small-muted">Enter your trip details to see instant pricing</p>
      </div>
      <div class="row justify-content-center">
        <div class="col-lg-11">
          <div class="booking-form-card p-3 shadow-sm rounded">

            <!-- Trip Type Selector -->
            <div class="trip-type-selector-horizontal d-flex justify-content-center gap-3 mb-3">
              <div class="trip-type-btn-horizontal active p-2" data-trip="oneway" style="cursor:pointer;">
                <i class="fas fa-route me-1"></i><span>One Way</span>
              </div>
              <div class="trip-type-btn-horizontal p-2" data-trip="roundtrip" style="cursor:pointer;">
                <i class="fas fa-exchange-alt me-1"></i><span>Round Trip</span>
              </div>
              <div class="trip-type-btn-horizontal p-2" data-trip="local" style="cursor:pointer;">
                <i class="fas fa-map-marked-alt me-1"></i><span>Local</span>
              </div>
            </div>

            <form id="bookingForm" onsubmit="return false;">
              <!-- One Way Form -->
              <div id="onewayForm" class="form-section active">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-map-marker-alt"></i> From</label>
                    <input type="text" class="form-control location-input" id="onewayPickup" placeholder="Enter starting location" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-flag-checkered"></i> To</label>
                    <input type="text" class="form-control location-input" id="onewayDrop" placeholder="Enter destination" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-calendar-alt"></i> Date & Time</label>
                    <input type="datetime-local" class="form-control" id="onewayDateTime" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-users"></i> Passengers</label>
                    <input type="number" class="form-control" id="onewayPassengers" placeholder="Number of people" min="1" max="50" required>
                  </div>
                  <div class="col-12 text-center mt-3">
                    <button type="button" class="btn btn-primary" id="onewayCheckBtn">
                      <i class="fas fa-calculator"></i> Check Prices
                    </button>
                  </div>
                </div>
              </div>

              <!-- Round Trip Form -->
              <div id="roundtripForm" class="form-section" style="display:none;">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-map-marker-alt"></i> From</label>
                    <input type="text" class="form-control location-input" id="roundtripPickup" placeholder="Enter starting location" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-flag-checkered"></i> To</label>
                    <input type="text" class="form-control location-input" id="roundtripDrop" placeholder="Enter destination" required>
                  </div>
                  <div class="col-12" id="intermediateStops"></div>
                  <div class="col-12">
                    <button type="button" class="add-stop-btn btn btn-outline-primary btn-sm" id="addStopBtn">
                      <i class="fas fa-plus-circle"></i> Add Stop
                    </button>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-calendar-alt"></i> Pickup Date & Time</label>
                    <input type="datetime-local" class="form-control" id="roundtripPickupDateTime" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-calendar-check"></i> Return Date & Time</label>
                    <input type="datetime-local" class="form-control" id="roundtripReturnDateTime" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-users"></i> Passengers</label>
                    <input type="number" class="form-control" id="roundtripPassengers" min="1" max="50" required>
                  </div>
                  <div class="col-12 text-center mt-3">
                    <button type="button" class="btn btn-primary" id="roundtripCheckBtn">
                      <i class="fas fa-calculator"></i> Check Prices
                    </button>
                  </div>
                </div>
              </div>

              <!-- Local Trip Form -->
              <div id="localForm" class="form-section" style="display:none;">
                <div class="local-package-selector mb-3 d-flex flex-wrap gap-2">
                  <div class="package-option p-2 border rounded" data-package="4hrs">
                    <div class="package-header fw-semibold">4 Hours</div>
                    <div class="package-detail small-muted">Free 40 KM</div>
                  </div>
                  <div class="package-option active p-2 border rounded" data-package="8hrs">
                    <div class="package-header fw-semibold">8 Hours</div>
                    <div class="package-detail small-muted">Free 80 KM</div>
                  </div>
                  <div class="package-option p-2 border rounded" data-package="10hrs">
                    <div class="package-header fw-semibold">10 Hours</div>
                    <div class="package-detail small-muted">Free 100 KM</div>
                  </div>
                  <div class="package-option p-2 border rounded" data-package="12hrs">
                    <div class="package-header fw-semibold">12 Hours</div>
                    <div class="package-detail small-muted">Free 120 KM</div>
                  </div>
                </div>

                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-map-marker-alt"></i> Pickup</label>
                    <input type="text" class="form-control location-input" id="localPickup" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-calendar-alt"></i> Date & Time</label>
                    <input type="datetime-local" class="form-control" id="localDateTime" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-users"></i> Passengers</label>
                    <input type="number" class="form-control" id="localPassengers" min="1" max="50" required>
                  </div>
                  <div class="col-12 text-center mt-3">
                    <button type="button" class="btn btn-primary" id="localCheckBtn">
                      <i class="fas fa-calculator"></i> Check Prices
                    </button>
                  </div>
                </div>
              </div>

              <!-- Loading Spinner -->
              <div class="loading-spinner text-center my-3" id="loadingSpinner" style="display:none;">
                <i class="fas fa-spinner fa-spin fa-3x text-primary"></i>
                <p class="small-muted">Calculating prices...</p>
              </div>

              <!-- Vehicle Selection -->
              <div id="vehicleTariffSection" class="vehicle-tariff-section" style="display:none;">
                <h5 class="text-center mb-3">Choose Your Vehicle</h5>

                <div id="vehicleTariffGrid" class="vehicle-tariff-grid"></div>
                <div id="paxWarning" class="text-center small-muted text-danger mt-2" style="display:none;"></div>

                <!-- Traveller info (shown only for local trips) -->
                <div id="travellerNote" class="text-center small-muted mt-3" style="display:none;">
                  <i class="fas fa-info-circle text-primary"></i>
                  For <b>Tempo Traveller</b> bookings, kindly call us at
                  <a href="tel:+919500530043" class="text-decoration-none fw-semibold">95005 30043</a>.
                </div>

                <div class="extra-charges-note mt-3 text-center small-muted">
                  <i class="fas fa-info-circle"></i> Note: Tolls, parking & permits are extra
                </div>
              </div>

              <!-- Customer Info Page -->
              <div id="customerInfoPage" style="display:none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <button id="backToVehiclesBtn" class="btn-back"><i class="fas fa-arrow-left"></i> Back</button>
                  <h5 class="mb-0">Your Details</h5>
                  <div style="width:64px"></div>
                </div>

                <p class="text-center small-muted mb-4">Please provide your name and contact number to continue.</p>
                <div class="row g-3">
                  <div class="col-md-6 mx-auto">
                    <label class="form-label"><i class="fas fa-user"></i> Full Name</label>
                    <input type="text" class="form-control" id="customerName" placeholder="Enter your full name" required>
                  </div>
                  <div class="col-md-6 mx-auto">
                    <label class="form-label"><i class="fas fa-phone"></i> Phone Number</label>
                    <input type="tel" class="form-control" id="customerPhone" placeholder="10-digit mobile number" pattern="[0-9]{10}" required>
                  </div>
                </div>
                <div class="text-center mt-4">
                  <button type="button" id="customerNextBtn" class="btn btn-success btn-lg w-100">Continue to Booking Summary</button>
                </div>
              </div>

              <!-- Booking Preview -->
              <div id="bookingPreviewSection" style="display:none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <button id="backToCustomerBtn" class="btn-back"><i class="fas fa-arrow-left"></i> Back</button>
                  <h5 class="mb-0">Booking Summary</h5>
                  <div style="width:64px"></div>
                </div>

                <div class="summary-box border rounded p-3 mb-3">
                  <p id="summaryTripDetails" class="mb-2"></p>
                  <p id="summaryVehicle" class="fw-bold mb-1"></p>
                  <p id="summaryBasePrice" class="text-primary fw-semibold mb-0"></p>
                </div>

                <!-- Fare Breakdown -->
                <div id="fareBreakdownBox" class="border rounded p-3 mb-3">
                  <h6 class="mb-2">Note</h6>
                  <pre id="fareBreakdownText" class="mb-0 small-muted"></pre>
                </div>

                <!-- Terms & Conditions -->
                <div id="termsBox" class="border rounded p-3 mb-3 bg-light small-muted">
                  <h6 class="mb-2"><i class="fas fa-info-circle text-primary"></i> Terms & Conditions</h6>
                  <ul id="termsList" class="mb-0 ps-3"></ul>
                </div>

                <!-- Add-ons -->
                <h6 class="mb-2">Add Extra Services (Optional)</h6>
                <div class="addon-options border rounded p-3 mb-3">
                  <div class="form-check">
                    <input class="form-check-input addon-checkbox" type="checkbox" id="addonLuggage" data-price="149">
                    <label class="form-check-label" for="addonLuggage">Cab with Luggage Carrier (+ ₹149)</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input addon-checkbox" type="checkbox" id="addonNewCar" data-price="249">
                    <label class="form-check-label" for="addonNewCar">New Car Promise (2022-2025 Model) (+ ₹249)</label>
                  </div>
                </div>

                <div class="fare-preview text-center mb-2">
                  <h5>Total Fare: <span id="totalFare" class="text-success fw-bold">₹0</span></h5>
                </div>

                <div class="text-center small-muted mb-3">Tolls, Parking & Permits are extra</div>

                <!-- TWO MAIN BUTTONS: WHATSAPP + PAY ONLINE -->
                <div class="d-flex flex-column flex-md-row gap-2 mb-3">
                  <button type="button" id="finalProceedBtn" class="btn btn-success btn-lg w-100">
                    <i class="fab fa-whatsapp"></i> Proceed
                  </button>

                  <button type="button" id="payOnlineBtn" class="btn btn-primary btn-lg w-100">
                    Pay Online
                  </button>
                </div>

                <!-- Payment Options (shown AFTER Pay Online is clicked) -->
                <div id="paymentOptionsSection" class="border rounded p-3 mb-3" style="display:none;">
                  <h6 class="mb-2">Choose Payment Option</h6>
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="paymentOption" id="payAdvance" value="advance">
                    <label class="form-check-label" for="payAdvance">
                      Pay Advance (10% of Total Fare)
                    </label>
                  </div>
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="paymentOption" id="payFull" value="full">
                    <label class="form-check-label" for="payFull">
                      Pay Full Amount
                    </label>
                  </div>
                  <button type="button" id="payNowBtn" class="btn btn-dark btn-lg w-100">
                    Pay Now
                  </button>
                </div>
              </div>

            </form>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Hero + Services + Features -->
  <section id="home" class="hero-section py-5">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-6 mb-4 mb-lg-0">
          <h1 class="hero-title">Premium Car Rental Services</h1>
          <p class="hero-subtitle small-muted">Comfortable, reliable, and affordable car hire across South India.</p>
          <a href="#booking" class="btn btn-primary btn-lg mt-3">Book Now <i class="fas fa-arrow-right ms-2"></i></a>
        </div>
        <div class="col-lg-6">
          <img src="images/flota.jpg" alt="Premium Car Rental" class="img-fluid rounded" onerror="this.src='https://images.unsplash.com/photo-1449965408869-eaa3f722e40d?w=800'">
        </div>
      </div>
    </div>
  </section>

  <div class="floating-contact d-flex flex-column">
    <a href="tel:+919500530043"
       class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center mb-2 shadow call-btn">
      <i class="bi bi-telephone-fill"></i>
    </a>

    <a href="https://wa.me/919500530043?text=Hello%20Prayaan%20Cabs%2C%20I%20need%20cab%20service."
       target="_blank"
       class="btn btn-success rounded-circle d-flex align-items-center justify-content-center shadow whatsapp-btn">
      <i class="bi bi-whatsapp"></i>
    </a>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="row">
        <div class="col-lg-4 mb-4">
          <h5><i class="fas fa-car"></i> Prayaan Cabs</h5>
          <p>Premium car rental services across South India. Reliable, affordable, and professional.</p>
          <div class="social-links">
            <a href="#"><i class="fab fa-facebook"></i></a>
            <a href="#"><i class="fab fa-instagram"></i></a>
            <a href="#"><i class="fab fa-twitter"></i></a>
            <a href="https://wa.me/919500530043"><i class="fab fa-whatsapp"></i></a>
          </div>
        </div>
        <div class="col-lg-4 mb-4">
          <h5>Quick Links</h5>
          <ul class="footer-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="services.html">Services</a></li>
            <li><a href="destinations.html">Destinations</a></li>
            <li><a href="about.html">About Us</a></li>
            <li><a href="booking.html">Book Now</a></li>
          </ul>
        </div>
        <div class="col-lg-4 mb-4">
          <h5>Contact Us</h5>
          <ul class="footer-contact">
            <li><i class="fas fa-phone"></i> +91 9500530043</li>
            <li><i class="fas fa-envelope"></i> prayaancabs@gmail.com</li>
            <li><i class="fas fa-map-marker-alt"></i> 6/391 B<br> Near SBIOA School<br> Sathyabhama Nagar<br> Pattanam <br> Coimbatore-641016 </li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 Prayaan Cabs. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Google Places -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBC6yIwGEbnc5IM_Fpa8M-CrZsnUt83BPQ&libraries=places"></script>

  <script>
  /* ====== Data & State ====== */
  const vehiclePricing = {
    oneway: {
      'Swift Dzire / Toyota Etios': { perKm: 20, icon: 'fa-car', image: 'images/sedan.png', category: 'Sedan' },
      'Mahindra Xylo / Ertiga':    { perKm: 24, icon: 'fa-car-side', image: 'images/ertiga.png', category: 'SUV' },
      'Innova':                    { perKm: 28, icon: 'fa-shuttle-van', image: 'images/innova.png', category: 'MPV' },
      'Innova Crysta (6+1)':       { perKm: 32, icon: 'fa-van-shuttle', image: 'images/crysta.png', category: 'Premium MPV' },
      'Innova Crysta (7+1)':       { perKm: 32, icon: 'fa-van-shuttle', image: 'images/crysta.png', category: 'Premium MPV' }
      // Traveller removed in ONE WAY
    },
    roundtrip: {
      'Swift Dzire / Toyota Etios': { dayRent: 2000, perKm: 12, icon: 'fa-car', image: 'images/sedan.png', category: 'Sedan' },
      'Mahindra Xylo / Ertiga':     { dayRent: 2200, perKm: 12, icon: 'fa-car-side', image: 'images/xuv.png', category: 'SUV' },
      'Innova':                     { dayRent: 2500, perKm: 14, icon: 'fa-shuttle-van', image: 'images/innova.png', category: 'MPV' },
      'Innova Crysta (6+1)':        { dayRent: 3000, perKm: 15, icon: 'fa-van-shuttle', image: 'images/crysta.png', category: 'Premium MPV' },
      'Innova Crysta (7+1)':        { dayRent: 3000, perKm: 15, icon: 'fa-van-shuttle', image: 'images/crysta.png', category: 'Premium MPV' },
      'Traveller':                  { dayRent: 3500, perKm: 18, icon: 'fa-bus', image: 'images/tempo.png', category: '12/14-seater TT' }
    },
    local: {
      '4hrs': {
        'Swift Dzire':         { packageRate: 1450, freeKm: 40, extraPerKm: 13, extraHour: 250, icon: 'fa-car', image: 'images/sedan.png', category: 'Sedan' },
        'Toyota Etios':        { packageRate: 1450, freeKm: 40, extraPerKm: 13, extraHour: 250, icon: 'fa-car', image: 'images/ertiga.png', category: 'Sedan' },
        'Innova':              { packageRate: 2200, freeKm: 40, extraPerKm: 15, extraHour: 300, icon: 'fa-shuttle-van', image: 'images/innova.png', category: 'MPV' },
        'Innova Crysta (6+1)': { packageRate: 2500, freeKm: 40, extraPerKm: 18, extraHour: 400, icon: 'fa-van-shuttle', image: 'images/crysta.png', category: 'Premium MPV' },
        'Innova Crysta (7+1)': { packageRate: 2500, freeKm: 40, extraPerKm: 18, extraHour: 400, icon: 'fa-van-shuttle', image: 'images/crysta.png', category: 'Premium MPV' },
        'Traveller':           { packageRate: 3000, freeKm: 40, extraPerKm: 19, extraHour: 450, icon: 'fa-bus', image: 'images/tempo.png', category: '12/14-seater TT' }
      },
      '8hrs': {
        'Swift Dzire':         { packageRate: 2450, freeKm: 80, extraPerKm: 13, extraHour: 250, icon: 'fa-car', image: 'images/sedan.png', category: 'Sedan' },
        'Toyota Etios':        { packageRate: 2450, freeKm: 80, extraPerKm: 13, extraHour: 250, icon: 'fa-car', image: 'images/ertiga.png', category: 'Sedan' },
        'Innova':              { packageRate: 3500, freeKm: 80, extraPerKm: 15, extraHour: 300, icon: 'fa-shuttle-van', image: 'images/innova.png', category: 'MPV' },
        'Innova Crysta (6+1)': { packageRate: 4500, freeKm: 80, extraPerKm: 18, extraHour: 500, icon: 'fa-van-shuttle', image: 'images/crysta.png', category: 'Premium MPV' },
        'Innova Crysta (7+1)': { packageRate: 4500, freeKm: 80, extraPerKm: 18, extraHour: 500, icon: 'fa-van-shuttle', image: 'images/crysta.png', category: 'Premium MPV' },
        'Traveller':           { packageRate: 4800, freeKm: 80, extraPerKm: 19, extraHour: 500, icon: 'fa-bus', image: 'images/tempo.png', category: '12/14-seater TT' }
      },
      '10hrs': {
        'Swift Dzire':         { packageRate: 2850, freeKm: 100, extraPerKm: 13, extraHour: 250, icon: 'fa-car', image: 'images/sedan.png', category: 'Sedan' },
        'Toyota Etios':        { packageRate: 2850, freeKm: 100, extraPerKm: 13, extraHour: 250, icon: 'fa-car', image: 'images/ertiga.png', category: 'Sedan' },
        'Innova':              { packageRate: 4000, freeKm: 100, extraPerKm: 15, extraHour: 300, icon: 'fa-shuttle-van', image: 'images/innova.png', category: 'MPV' },
        'Innova Crysta (6+1)': { packageRate: 5000, freeKm: 100, extraPerKm: 18, extraHour: 500, icon: 'fa-van-shuttle', image: 'images/crysta.png', category: 'Premium MPV' },
        'Innova Crysta (7+1)': { packageRate: 5000, freeKm: 100, extraPerKm: 18, extraHour: 500, icon: 'fa-van-shuttle', image: 'images/crysta.png', category: 'Premium MPV' },
        'Traveller':           { packageRate: 5300, freeKm: 100, extraPerKm: 19, extraHour: 500, icon: 'fa-bus', image: 'images/tempo.png', category: '12/14-seater TT' }
      },
      '12hrs': {
        'Swift Dzire':         { packageRate: 3400, freeKm: 120, extraPerKm: 13, extraHour: 250, icon: 'fa-car', image: 'images/sedan.png', category: 'Sedan' },
        'Toyota Etios':        { packageRate: 3400, freeKm: 120, extraPerKm: 13, extraHour: 250, icon: 'fa-car', image: 'images/ertiga.png', category: 'Sedan' },
        'Innova':              { packageRate: 4800, freeKm: 120, extraPerKm: 15, extraHour: 300, icon: 'fa-shuttle-van', image: 'images/innova.png', category: 'MPV' },
        'Innova Crysta (6+1)': { packageRate: 5800, freeKm: 120, extraPerKm: 18, extraHour: 500, icon: 'fa-van-shuttle', image: 'images/crysta.png', category: 'Premium MPV' },
        'Innova Crysta (7+1)': { packageRate: 5800, freeKm: 120, extraPerKm: 18, extraHour: 500, icon: 'fa-van-shuttle', image: 'images/crysta.png', category: 'Premium MPV' },
        'Traveller':           { packageRate: 6000, freeKm: 120, extraPerKm: 19, extraHour: 500, icon: 'fa-bus', image: 'images/tempo.png', category: '12/14-seater TT' }
      }
    }
  };

  let currentTripType = 'oneway';
  let selectedLocalPackage = '8hrs';
  let intermediateStopCount = 0;
  let autocompleteInstances = [];
  let selectedVehicle = null;
  let lastComputedDistance = 0;
  let lastComputedDays = 1;
  let lastBasePrice = 0;
  let lastCgst = 0;
  let lastSgst = 0;
  let lastGst = 0;

  /* ====== Autocomplete init ====== */
  function initAutocomplete(){
    document.querySelectorAll('.location-input').forEach(input => {
      if (!input.dataset.autoinit) {
        try {
          const ac = new google.maps.places.Autocomplete(input, { componentRestrictions: { country: 'in' } });
          autocompleteInstances.push(ac);
        } catch (e) {
          // fail silently if API not available
        }
        input.dataset.autoinit = '1';
      }
    });
  }

  /* ====== Update form sections (enable/disable) ====== */
  function updateFormSections(){
    document.querySelectorAll('.form-section').forEach(section=>{
      const isActive = section.style.display !== 'none';
      section.querySelectorAll('input, select, textarea, button').forEach(el=>{
        if (el === document.getElementById('addStopBtn')) return;
        el.disabled = !isActive;
      });
    });
  }

  /* ====== Trip type switcher ====== */
  document.getElementById('vehicleTariffSection').style.display = 'none';

  document.querySelectorAll('.trip-type-btn-horizontal').forEach(btn=>{
    btn.addEventListener('click', function(){
      document.querySelectorAll('.trip-type-btn-horizontal').forEach(b=>b.classList.remove('active'));
      this.classList.add('active');
      currentTripType = this.dataset.trip;
      // show/hide forms
      document.getElementById('onewayForm').style.display = currentTripType==='oneway' ? 'block' : 'none';
      document.getElementById('roundtripForm').style.display = currentTripType==='roundtrip' ? 'block' : 'none';
      document.getElementById('localForm').style.display = currentTripType==='local' ? 'block' : 'none';
      // hide downstream pages
      document.getElementById('vehicleTariffSection').style.display = 'none';
      document.getElementById('customerInfoPage').style.display = 'none';
      document.getElementById('bookingPreviewSection').style.display = 'none';
      updateFormSections();
      initAutocomplete();
    });
  });

  /* ====== Add / remove stops ====== */
  document.getElementById('addStopBtn').addEventListener('click', ()=>{
    intermediateStopCount++;
    const stopDiv = document.createElement('div');
    stopDiv.className = 'intermediate-stop mb-2';
    stopDiv.innerHTML = `
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">Stop ${intermediateStopCount}</h6>
        <button type="button" class="remove-stop-btn btn btn-sm btn-outline-danger"><i class="fas fa-times"></i></button>
      </div>
      <input type="text" class="form-control location-input" placeholder="Enter location">
    `;
    document.getElementById('intermediateStops').appendChild(stopDiv);
    const removeBtn = stopDiv.querySelector('.remove-stop-btn');
    removeBtn.addEventListener('click', ()=>{ stopDiv.remove(); updateFormSections(); });
    const newInput = stopDiv.querySelector('.location-input');
    try { new google.maps.places.Autocomplete(newInput, { componentRestrictions: { country: 'in' } }); } catch(e){}
  });

  /* ====== Distance calc helper (Google DistanceMatrix) ====== */
  async function calculateDistance(origins, destinations) {
    return new Promise((resolve, reject)=>{
      try {
        const service = new google.maps.DistanceMatrixService();
        service.getDistanceMatrix({
          origins, destinations, travelMode: google.maps.TravelMode.DRIVING, unitSystem: google.maps.UnitSystem.METRIC
        }, (response, status) => {
          if (status === 'OK') resolve(response);
          else reject(status);
        });
      } catch(e) {
        reject(e);
      }
    });
  }

  /* ====== MAIN PRICING FLOW ====== */
  async function calculateAndDisplayAllPrices(){
    const spinner = document.getElementById('loadingSpinner');
    spinner.style.display = 'block';
    document.getElementById('vehicleTariffSection').style.display = 'none';
    document.getElementById('customerInfoPage').style.display = 'none';
    document.getElementById('bookingPreviewSection').style.display = 'none';

    try {
      let totalDistance = 0;
      let days = 1;

      function isCoimbatoreLocation(text){
        if (!text) return false;
        return text.toLowerCase().includes('coimbatore');
      }

      if (currentTripType === 'oneway') {
        const from = document.getElementById('onewayPickup').value.trim();
        const to   = document.getElementById('onewayDrop').value.trim();
        const pax  = parseInt(document.getElementById('onewayPassengers').value || 0);
        if (!from || !to || pax <= 0) { spinner.style.display = 'none'; return; }

        const res = await calculateDistance([from], [to]);
        const forwardDistance = (res.rows[0].elements[0].distance.value || 0) / 1000;

        totalDistance = forwardDistance;
        lastComputedDistance = Math.round(totalDistance);
        lastComputedDays = 1;

        displayAllVehiclePrices(totalDistance, 1);
      }
      else if (currentTripType === 'roundtrip') {
        const from = document.getElementById('roundtripPickup').value.trim();
        const to   = document.getElementById('roundtripDrop').value.trim();
        const pickupRaw = document.getElementById('roundtripPickupDateTime').value;
        const returnRaw = document.getElementById('roundtripReturnDateTime').value;
        if (!from || !to || !pickupRaw || !returnRaw) { spinner.style.display='none'; return; }

        // inclusive calendar days
        const pDateFull = new Date(pickupRaw);
        const rDateFull = new Date(returnRaw);
        const msPerDay = 1000 * 60 * 60 * 24;
        let rawDays = Math.floor((rDateFull - pDateFull) / msPerDay) + 1;
        if (!isFinite(rawDays) || rawDays < 1) rawDays = 1;
        days = rawDays;

        // forward distance across stops
        const locs = [from];
        document.querySelectorAll('#intermediateStops .location-input').forEach(i => {
          if (i.value && i.value.trim()) locs.push(i.value.trim());
        });
        locs.push(to);

        let forwardDistance = 0;
        for (let i = 0; i < locs.length - 1; i++) {
          try {
            const res = await calculateDistance([locs[i]], [locs[i+1]]);
            forwardDistance += ((res.rows[0].elements[0].distance.value || 0) / 1000);
          } catch(e){}
        }

        // return distance (Coimbatore based)
        let returnDistance = 0;
        if (isCoimbatoreLocation(from)) {
          const coimbatore = "Coimbatore, Tamil Nadu";
          try {
            const resBack = await calculateDistance([to],[coimbatore]);
            returnDistance = (resBack.rows[0].elements[0].distance.value || 0) / 1000;
          } catch(e){}
        }

        totalDistance = forwardDistance + returnDistance;
        lastComputedDistance = Math.round(totalDistance);
        lastComputedDays = days;
        displayAllVehiclePrices(totalDistance, days);
      }
      else if (currentTripType === 'local') {
        displayLocalTariffs();
      }

    } catch(e){
      console.error(e);
      alert('Unable to calculate distance. Please check locations and try again.');
    } finally {
      spinner.style.display = 'none';
    }
  }

  /* ====== Attach handler when clicking a vehicle card ====== */
  function attachVehicleClickHandler(card, basePrice){
    card.addEventListener('click', ()=>{
      document.querySelectorAll('.vehicle-tariff-card').forEach(c=>c.classList.remove('selected'));
      card.classList.add('selected');
      selectedVehicle = card.querySelector('.vehicle-name-horizontal').textContent.trim();
      lastBasePrice = basePrice;

      // hide forms
      document.getElementById('vehicleTariffSection').style.display = 'none';
      document.getElementById('onewayForm').style.display = 'none';
      document.getElementById('roundtripForm').style.display = 'none';
      document.getElementById('localForm').style.display = 'none';

      // show customer info
      document.getElementById('customerInfoPage').style.display = 'block';
      document.getElementById('bookingPreviewSection').style.display = 'none';
    });
  }

  /* ====== helper: strip HTML for WhatsApp ====== */
  function stripHtml(html){
    const tmp = document.createElement('DIV');
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || "";
  }

  /* ====== Terms & Conditions Sets ====== */
  const terms = {
    oneway: [
      "__EXTRAKM__",
      "One pickup at origin and one drop at destination. No within-city travel included.",
      "AC may be switched off during hill climbs.",
      "Multiple pickups/drops may incur extra charges."
    ],
    roundtrip: [
      "Trip includes a KM limit; extra KM charged as per the vehicle.",
      "Toll, parking, state permit & airport entry fees are extra.",
      "Night driving allowance applies between 9:45 PM and 6:00 AM.",
      "All planned cities must be informed in advance; adding cities mid-trip may not be possible.",
      "AC may be turned off during hill climbs."
    ],
    local: [
      "Package includes fixed KM and hours; excess KM/hours charged as per the vehicle.",
      "KM & hours count from pickup and back to pickup point.",
      "Toll, parking, permit & airport entry charges are extra.",
      "Night driving allowance applies between 9:45 PM and 6:00 AM."
    ]
  };

  /* ====== Show booking preview and fare breakdown ====== */
  function showBookingPreview() {
    document.getElementById('vehicleTariffSection').style.display = 'none';
    document.getElementById('customerInfoPage').style.display = 'none';

    let summaryHTML = '';
    let breakdown = '';

    if (currentTripType === 'oneway') {
      const from = document.getElementById('onewayPickup').value;
      const to   = document.getElementById('onewayDrop').value;
      const dt   = new Date(document.getElementById('onewayDateTime').value).toLocaleString('en-IN');
      const pax  = document.getElementById('onewayPassengers').value;
      const distance = lastComputedDistance || 0;

      summaryHTML =
        `<b>From:</b> ${from}<br><b>To:</b> ${to}<br><b>Date & Time:</b> ${dt}`+
        `<br><b>Passengers:</b> ${pax}<br><b>Distance:</b> ${distance} km`;

      const cfg = vehiclePricing.oneway[selectedVehicle] || {};
      const perKm = cfg.perKm || 0;

      const extraKMText = `Extra KM Charge: ₹${perKm} / km`;
      terms.oneway[0] = extraKMText;

      lastBasePrice = Math.round(perKm * distance);

      breakdown = `Distance: ${distance} km\nRate: ₹${perKm} /km\nBase Fare: ₹${lastBasePrice}`;
    }
    else if (currentTripType === 'roundtrip') {
      const from = document.getElementById('roundtripPickup').value;
      const to   = document.getElementById('roundtripDrop').value;
      const pickup = new Date(document.getElementById('roundtripPickupDateTime').value).toLocaleString('en-IN');
      const ret    = new Date(document.getElementById('roundtripReturnDateTime').value).toLocaleString('en-IN');
      const pax    = document.getElementById('roundtripPassengers').value;
      const distance = lastComputedDistance || 0;
      const days     = lastComputedDays || 1;

      let stops = [];
      document.querySelectorAll('#intermediateStops .location-input').forEach(i => {
        if (i.value && i.value.trim()) stops.push(i.value.trim());
      });
      const stopLine = stops.length ? `<b>Intermediate Stops:</b> ${stops.join(', ')}<br>` : '';

      summaryHTML =
        `<b>From:</b> ${from}<br>${stopLine}<b>To:</b> ${to}`+
        `<br><b>Pickup:</b> ${pickup}<br><b>Return:</b> ${ret}`+
        `<br><b>Passengers:</b> ${pax}<br><b>Total Distance:</b> ${distance} km`;

      const cfg = vehiclePricing.roundtrip[selectedVehicle] || {};
      const dayRent = cfg.dayRent || 0;
      const perKm   = cfg.perKm || 0;
      const baseTotal = Math.round((dayRent * days) + (perKm * distance));
      lastBasePrice = baseTotal;

      breakdown =
        `No. of Days: ${days}\nKilometer limit: ${distance} km\n`+
        `Base Fare: ₹${baseTotal}`;
    }
    else {
      const pickup  = document.getElementById('localPickup').value;
      const dt      = new Date(document.getElementById('localDateTime').value).toLocaleString('en-IN');
      const pax     = document.getElementById('localPassengers').value;

      summaryHTML =
        `<b>Pickup:</b> ${pickup}<br><b>Date & Time:</b> ${dt}`+
        `<br><b>Passengers:</b> ${pax}<br><b>Package:</b> ${selectedLocalPackage.toUpperCase()}`;

      const pkgCfg = vehiclePricing.local[selectedLocalPackage] || {};
      if (pkgCfg[selectedVehicle]) {
        const pkg = pkgCfg[selectedVehicle];
        lastBasePrice = pkg.packageRate;
        breakdown =
          `Package Rate: ₹${pkg.packageRate}\nFree KM: ${pkg.freeKm} km\n`+
          `Extra KM: ₹${pkg.extraPerKm} /km\nExtra Hour: ₹${pkg.extraHour} /hour`;
      } else {
        lastBasePrice = 0;
        breakdown = 'Package details not available.';
      }
    }

    // GST on Base – split as CGST & SGST
    lastCgst = Math.round(lastBasePrice * 0.025);
    lastSgst = Math.round(lastBasePrice * 0.025);
    lastGst  = lastCgst + lastSgst;
    breakdown += `\nCGST (2.5%): ₹${lastCgst}\nSGST (2.5%): ₹${lastSgst}\nTotal GST: ₹${lastGst}`;

    document.getElementById('fareBreakdownText').textContent = breakdown;
    document.getElementById('summaryTripDetails').innerHTML = summaryHTML;
    document.getElementById('summaryVehicle').textContent = `Vehicle: ${selectedVehicle || 'Not selected'}`;
    document.getElementById('summaryBasePrice').textContent = `Base Fare: ₹${lastBasePrice}`;

    // Insert Dynamic Terms
    const t = terms[currentTripType] || [];
    const ul = document.getElementById('termsList');
    ul.innerHTML = t.map(item => `<li>${item}</li>`).join('');

    document.getElementById('bookingPreviewSection').style.display = 'block';

    // reset add-ons
    document.querySelectorAll('.addon-checkbox').forEach(chk => { chk.checked = false; });

    // update total when add-ons change (base + GST + addons)
    function updateTotalFare(){
      let addons = 0;
      document.querySelectorAll('.addon-checkbox:checked').forEach(chk => {
        addons += parseInt(chk.dataset.price || 0, 10);
      });
      const total = lastBasePrice + lastGst + addons;
      document.getElementById('totalFare').textContent = `₹${total}`;
    }

    updateTotalFare(); // initial
    document.querySelectorAll('.addon-checkbox').forEach(chk => {
      chk.onchange = updateTotalFare;
    });

    // hide payment options until user clicks Pay Online
    document.getElementById('paymentOptionsSection').style.display = 'none';
  }

  /* ====== Display available vehicles (oneway/roundtrip) ====== */
  function displayAllVehiclePrices(distance, days) {
    const data = vehiclePricing[currentTripType] || {};
    const grid = document.getElementById('vehicleTariffGrid');
    const paxWarning = document.getElementById('paxWarning');
    grid.innerHTML = '';
    paxWarning.style.display = 'none';
    paxWarning.textContent = '';

    const paxField = document.querySelector(`#${currentTripType}Passengers`);
    const pax = parseInt(paxField ? paxField.value : 0, 10) || 0;

    // In ONE WAY, if pax > 7 show warning & no vehicles
    if (currentTripType === 'oneway' && pax > 7) {
      paxWarning.textContent = "For more than 7 passengers, please contact us for Tempo Traveller bookings.";
      paxWarning.style.display = 'block';
      document.getElementById('vehicleTariffSection').style.display = 'block';
      return;
    }

    Object.keys(data).forEach(v => {
      const p = data[v]; // vehicle pricing object

      if (pax > 0) {
        // Hide Sedan above 4 passengers
        if (pax > 4 && (
          v.includes('Swift Dzire') ||
          v.includes('Toyota Etios')
        )) return;

        // Crysta seating rules
        if (v.includes('Innova Crysta (6+1)') && pax > 6) return;
        if (v.includes('Innova Crysta (7+1)') && pax > 7) return;

        // Innova & SUV limit 7+1
        if ((v.includes('Innova') && !v.includes('Crysta')) && pax > 7) return;
        if ((v.includes('Xylo') || v.includes('Ertiga') || v.includes('SUV')) && pax > 7) return;

        // Tempo Traveller rule
        if (v.includes('Traveller')) {
          if (currentTripType === 'oneway' || currentTripType === 'local') return;
          if (pax <= 7) return;
        }
      }

      let total = 0;
      if (currentTripType === 'oneway') {
        const perKm = p.perKm || 0;
        total = Math.round(distance * perKm);
      } else {
        const dayRent = p.dayRent || 0;
        const perKm = p.perKm || 0;
        total = Math.round((dayRent * days) + (distance * perKm));
      }

      const card = document.createElement('div');
      card.className = 'vehicle-tariff-card';
      card.innerHTML = `
        <div style="min-height:56px;">
          <div class="vehicle-icon-circle-horizontal"><img src="${p.image}" alt="${v}" onerror="this.style.display='none'"></div>
          <div class="vehicle-name-horizontal">${v}</div>
          <div class="vehicle-category">${p.category||''}</div>
        </div>
        <div class="tariff-price">Rs. ${total}</div>
      `;
      grid.appendChild(card);
      attachVehicleClickHandler(card, total);
    });

    document.getElementById('vehicleTariffSection').style.display = 'block';
  }

  /* ====== Display local package vehicles ====== */
  function displayLocalTariffs() {
    const data = vehiclePricing.local[selectedLocalPackage] || {};
    const grid = document.getElementById('vehicleTariffGrid');
    grid.innerHTML = '';
    const pax = parseInt(document.getElementById('localPassengers').value || 0, 10) || 0;

    Object.keys(data).forEach(v => {
      // Skip Traveller completely for Local
      if (v.toLowerCase().includes('traveller')) return;

      // Sedan hide when pax == 5
      if (pax === 5 && (v === 'Swift Dzire' || v === 'Toyota Etios')) return;

      // Crysta split rules
      if (v === 'Innova Crysta (6+1)' && pax === 7) return;
      if (v === 'Innova Crysta (7+1)' && pax <= 6 && pax > 0) return;

      const p = data[v];
      const base = p.packageRate || 0;
      const card = document.createElement('div');
      card.className = 'vehicle-tariff-card';
      card.innerHTML = `
        <div style="min-height:56px;">
          <div class="vehicle-icon-circle-horizontal">
            <img src="${p.image}" alt="${v}" onerror="this.style.display='none'">
          </div>
          <div class="vehicle-name-horizontal">${v}</div>
          <div class="vehicle-category">${p.category || ''}</div>
        </div>
        <div class="tariff-price">Rs. ${base}</div>
      `;
      grid.appendChild(card);
      attachVehicleClickHandler(card, base);
    });

    document.getElementById('travellerNote').style.display = 'block';
    document.getElementById('vehicleTariffSection').style.display = 'block';
  }

  /* ====== Input listeners to trigger calculation ====== */
  document.querySelectorAll('#onewayPassengers, #roundtripPassengers, #localPassengers').forEach(inp=>{
    inp.addEventListener('change', ()=> { if (parseInt(inp.value||0,10) > 0) calculateAndDisplayAllPrices(); });
  });

  document.querySelectorAll('.package-option').forEach(opt=>{
    opt.addEventListener('click', function(){
      document.querySelectorAll('.package-option').forEach(o=>o.classList.remove('active'));
      this.classList.add('active');
      selectedLocalPackage = this.dataset.package;
      if (currentTripType === 'local') displayLocalTariffs();
    });
  });

  /* ====== Back buttons behavior ====== */
  document.getElementById('backToVehiclesBtn').addEventListener('click', ()=>{
    document.getElementById('customerInfoPage').style.display = 'none';
    document.getElementById('vehicleTariffSection').style.display = 'block';
    document.getElementById('onewayForm').style.display = currentTripType==='oneway' ? 'block' : 'none';
    document.getElementById('roundtripForm').style.display = currentTripType==='roundtrip' ? 'block' : 'none';
    document.getElementById('localForm').style.display = currentTripType==='local' ? 'block' : 'none';
  });
  document.getElementById('backToCustomerBtn').addEventListener('click', ()=>{
    document.getElementById('bookingPreviewSection').style.display = 'none';
    document.getElementById('customerInfoPage').style.display = 'block';
  });

  /* ====== Customer continue to preview ====== */
  document.getElementById('customerNextBtn').addEventListener('click', ()=>{
    const name = document.getElementById('customerName').value.trim();
    const phone = document.getElementById('customerPhone').value.trim();
    if (!name || !phone) {
      alert('Please enter name and phone.');
      return;
    }
    showBookingPreview();
  });

  /* ====== Final WhatsApp button ====== */
  document.getElementById('finalProceedBtn').addEventListener('click', ()=>{
    const name = document.getElementById('customerName').value.trim();
    const phone = document.getElementById('customerPhone').value.trim();
    if (!name || !phone) { alert('Please enter name and phone.'); return; }

    // Ensure pickup time is at least 1 hour from now
    let pickupTime = null;
    if (currentTripType === 'oneway') {
      pickupTime = new Date(document.getElementById('onewayDateTime').value);
    } else if (currentTripType === 'roundtrip') {
      pickupTime = new Date(document.getElementById('roundtripPickupDateTime').value);
    } else if (currentTripType === 'local') {
      pickupTime = new Date(document.getElementById('localDateTime').value);
    }

    if (pickupTime && !isNaN(pickupTime)) {
      const now = new Date();
      const diffMinutes = (pickupTime - now) / (1000 * 60);
      if (diffMinutes < 60) {
        alert('⚠️ Please book at least 1 hour before pickup time.');
        return;
      }
    }

    const totalText = document.getElementById('totalFare').textContent.replace('₹','').trim();
    const addons = [];
    document.querySelectorAll('.addon-checkbox:checked').forEach(chk=>{
      addons.push(chk.nextElementSibling.textContent.trim());
    });
    const addonText = addons.length ? `\nAdd-ons:\n- ${addons.join('\n- ')}` : '';

    const tripDetails = stripHtml(document.getElementById('summaryTripDetails').innerHTML);
    const breakdown   = document.getElementById('fareBreakdownText').textContent;

    const msg =
`🚗 New Booking - Prayaan Cabs

Name: ${name}
Phone: ${phone}
Trip Type: ${currentTripType.toUpperCase()}
Vehicle: ${selectedVehicle}
Base Fare: ₹${lastBasePrice}
CGST (2.5%): ₹${lastCgst}
SGST (2.5%): ₹${lastSgst}
Total Fare: ₹${totalText}${addonText}

Trip Details:
${tripDetails}

Additional Charges / Notes:
${breakdown}

Note: Tolls, parking & permits are extra.`;

    const waUrl = `https://wa.me/919500530043?text=${encodeURIComponent(msg)}`;
    window.open(waUrl, '_blank');
  });

  function sendToWhatsappAfterPayment(paymentId, paidAmount) {
    const name = document.getElementById('customerName').value.trim();
    const phone = document.getElementById('customerPhone').value.trim();
    const tripDetails = stripHtml(document.getElementById('summaryTripDetails').innerHTML);
    const breakdown   = document.getElementById('fareBreakdownText').textContent;
    const totalFare = parseInt(document.getElementById('totalFare').textContent.replace('₹','').trim());

    const balance = totalFare - paidAmount;

    const msg =
`🚗 *New Booking - Prayaan Cabs*

Name: ${name}
Phone: ${phone}

*Payment Completed*
Payment ID: ${paymentId}
Paid Amount: ₹${paidAmount}
Balance: ₹${balance}

Trip Details:
${tripDetails}

Fare Breakdown:
${breakdown}

Note: Tolls, parking & permits extra.`;

    const waUrl = `https://wa.me/919500530043?text=${encodeURIComponent(msg)}`;
    window.open(waUrl, "_blank");
  }

  /* ====== When user changes main fields -> recalc ====== */
  window.addEventListener('load', ()=>{
    initAutocomplete();
    updateFormSections();
    // set min for datetime-local inputs
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.querySelectorAll('input[type="datetime-local"]').forEach(i => i.min = now.toISOString().slice(0,16));

    function triggerRecalculation() {
      if (currentTripType === 'oneway') {
        const from = document.getElementById('onewayPickup').value.trim();
        const to   = document.getElementById('onewayDrop').value.trim();
        const pax  = parseInt(document.getElementById('onewayPassengers').value || 0);
        if (from && to && pax > 0) calculateAndDisplayAllPrices();
      }
      else if (currentTripType === 'roundtrip') {
        const from = document.getElementById('roundtripPickup').value.trim();
        const to   = document.getElementById('roundtripDrop').value.trim();
        const pickup = document.getElementById('roundtripPickupDateTime').value;
        const ret    = document.getElementById('roundtripReturnDateTime').value;
        const pax    = parseInt(document.getElementById('roundtripPassengers').value || 0);
        if (from && to && pickup && ret && pax > 0) calculateAndDisplayAllPrices();
      }
      else if (currentTripType === 'local') {
        const pickup = document.getElementById('localPickup').value.trim();
        const dt     = document.getElementById('localDateTime').value;
        const pax    = parseInt(document.getElementById('localPassengers').value || 0);
        if (pickup && dt && pax > 0) calculateAndDisplayAllPrices();
      }
    }

    [
      'onewayPickup','onewayDrop','onewayDateTime','onewayPassengers',
      'roundtripPickup','roundtripDrop','roundtripPickupDateTime','roundtripReturnDateTime','roundtripPassengers',
      'localPickup','localDateTime','localPassengers'
    ].forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.addEventListener('change', triggerRecalculation);
    });
  });

  /* ====== "Check Prices" button handlers ====== */
  document.getElementById('onewayCheckBtn').addEventListener('click', () => {
    const from = document.getElementById('onewayPickup').value.trim();
    const to   = document.getElementById('onewayDrop').value.trim();
    const pax  = parseInt(document.getElementById('onewayPassengers').value || 0);
    if (!from || !to || pax <= 0) {
      alert('Please enter From, To and Passenger details.');
      return;
    }
    calculateAndDisplayAllPrices();
  });

  document.getElementById('roundtripCheckBtn').addEventListener('click', () => {
    const from = document.getElementById('roundtripPickup').value.trim();
    const to   = document.getElementById('roundtripDrop').value.trim();
    const pickup = document.getElementById('roundtripPickupDateTime').value;
    const ret    = document.getElementById('roundtripReturnDateTime').value;
    const pax    = parseInt(document.getElementById('roundtripPassengers').value || 0);
    if (!from || !to || !pickup || !ret || pax <= 0) {
      alert('Please enter all details before checking prices.');
      return;
    }
    calculateAndDisplayAllPrices();
  });

  document.getElementById('localCheckBtn').addEventListener('click', () => {
    const pickup = document.getElementById('localPickup').value.trim();
    const dt     = document.getElementById('localDateTime').value;
    const pax    = parseInt(document.getElementById('localPassengers').value || 0);
    if (!pickup || !dt || pax <= 0) {
      alert('Please enter Pickup, Date & Passenger details.');
      return;
    }
    calculateAndDisplayAllPrices();
  });

  /* ====== SAVE TO SHEET (Bookings / Sheet1) ====== */
  async function saveToSheet(paymentType, paymentAmount, paymentId = "", paymentStatus = "Pending") {
    const totalFareText = document.getElementById("totalFare").textContent.replace("₹","").trim();

    const payload = {
      name: document.getElementById('customerName').value.trim(),
      phone: document.getElementById('customerPhone').value.trim(),
      tripType: currentTripType,
      pickup:
        currentTripType === "oneway"
          ? document.getElementById("onewayPickup").value
          : currentTripType === "roundtrip"
          ? document.getElementById("roundtripPickup").value
          : document.getElementById("localPickup").value,
      drop:
        currentTripType === "oneway"
          ? document.getElementById("onewayDrop").value
          : currentTripType === "roundtrip"
          ? document.getElementById("roundtripDrop").value
          : "",
      datetime: new Date().toLocaleString("en-IN"),
      vehicle: selectedVehicle,
      baseFare: lastBasePrice,
      gst: lastGst,
      addons: Array.from(document.querySelectorAll('.addon-checkbox:checked')).map(c => c.nextElementSibling.textContent.trim()).join(', '),
      totalFare: totalFareText,
      paymentType,
      paymentAmount,
      paymentStatus,
      paymentId
    };

    // 🔴 Your Web App URL (Google Apps Script)
    const scriptUrl = "https://script.google.com/macros/s/AKfycbwLiz394-vUSknp5pXgLtsJBjCnsGrH3myJjY8KvAw7xdS9t0zMwrEsjOEIl6EL0twW/exec";

    const res = await fetch(scriptUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    // NOT throwing if fails, you can inspect if needed:
    if (!res.ok) {
      console.warn("Sheet save returned non-OK status:", res.status);
    }
  }

  /* ====== PAY ONLINE → GO TO PAYMENT OPTIONS (ALWAYS) ====== */
  document.getElementById("payOnlineBtn").addEventListener("click", async function () {
    try {
      await saveToSheet("Online", 0, "", "Pending");
    } catch (e) {
      console.warn("saveToSheet failed before payment, continuing anyway:", e);
    }

    const section = document.getElementById("paymentOptionsSection");
    section.style.display = "block";
    section.scrollIntoView({ behavior: "smooth" });
  });

  /* ====== PAY NOW → RAZORPAY (Advance / Full) ====== */
  document.getElementById("payNowBtn").addEventListener("click", function () {
    const option = document.querySelector("input[name='paymentOption']:checked");
    if (!option) {
      alert("Please select a payment option (Advance or Full).");
      return;
    }

    const totalFare = parseInt(document.getElementById("totalFare").textContent.replace("₹","").trim());
    if (!totalFare || isNaN(totalFare)) {
      alert("Total fare is not calculated. Please check details again.");
      return;
    }

    let payableAmount = 0;
    let paymentTypeLabel = "";

    if (option.value === "advance") {
      payableAmount = Math.round(totalFare * 0.10);
      paymentTypeLabel = "Online Advance";
    } else {
      payableAmount = totalFare;
      paymentTypeLabel = "Online Full";
    }

    const razorAmount = payableAmount * 100;

    const rzpOptions = {
      key: "rzp_live_RhxzNJboDF9avv", // 🔴 Your Razorpay Key
      amount: razorAmount,
      currency: "INR",
      name: "Prayaan Cabs",
      description: "Cab Booking Payment",
      handler: async function (response) {
        const paymentId = response.razorpay_payment_id;

        // Try to save as PAID in sheet – even if fails, continue WhatsApp
        try {
          await saveToSheet(paymentTypeLabel, payableAmount, paymentId, "Paid");
        } catch (e) {
          console.warn("saveToSheet failed after payment:", e);
        }

        // WhatsApp confirmation with payment details
        sendToWhatsappAfterPayment(paymentId, payableAmount);
      },
      theme: {
        color: "#0d6efd"
      }
    };

    const rzp = new Razorpay(rzpOptions);
    rzp.open();
  });

  </script>
</body>
</html>
